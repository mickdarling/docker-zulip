services:
  database:
    image: "zulip/zulip-postgresql:14"
    restart: unless-stopped
    environment:
      POSTGRES_DB: "zulip"
      POSTGRES_USER: "zulip"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
    volumes:
      - "postgresql-14:/var/lib/postgresql/data:rw"

  memcached:
    image: "memcached:alpine"
    restart: unless-stopped
    command:
      - "sh"
      - "-euc"
      - |
        echo 'mech_list: plain' > "$$SASL_CONF_PATH"
        echo "zulip@$$HOSTNAME:$$MEMCACHED_PASSWORD" > "$$MEMCACHED_SASL_PWDB"
        echo "zulip@localhost:$$MEMCACHED_PASSWORD" >> "$$MEMCACHED_SASL_PWDB"
        exec memcached -S
    environment:
      SASL_CONF_PATH: "/home/memcache/memcached.conf"
      MEMCACHED_SASL_PWDB: "/home/memcache/memcached-sasl-db"
      MEMCACHED_PASSWORD: "${MEMCACHED_PASSWORD}"

  rabbitmq:
    image: "rabbitmq:4.1"
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: "zulip"
      RABBITMQ_DEFAULT_PASS: "${RABBITMQ_PASSWORD}"
    volumes:
      - "rabbitmq:/var/lib/rabbitmq:rw"

  redis:
    image: "redis:alpine"
    restart: unless-stopped
    command:
      - "sh"
      - "-euc"
      - |
        echo "requirepass '$$REDIS_PASSWORD'" > /etc/redis.conf
        exec redis-server /etc/redis.conf
    environment:
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
    volumes:
      - "redis:/data:rw"

  zulip:
    # To use custom_zulip_files/, build from source instead of using pre-built image
    # This takes ~30-45 minutes but includes the Merview integration
    build:
      context: .
      args:
        ZULIP_GIT_REF: "11.4"
    # Fallback to pre-built image (comment out 'build:' section above, uncomment below):
    # image: "zulip/docker-zulip:11.4-0"
    restart: unless-stopped
    ports:
      # Using port 9080 to avoid conflict with Huly on port 80
      - "9080:80"
      - "9443:443"
    environment:
      DB_HOST: "database"
      DB_HOST_PORT: "5432"
      DB_USER: "zulip"
      SSL_CERTIFICATE_GENERATION: "self-signed"
      SETTING_MEMCACHED_LOCATION: "memcached:11211"
      SETTING_RABBITMQ_HOST: "rabbitmq"
      SETTING_REDIS_HOST: "redis"

      # Secrets - these must match the passwords above
      SECRETS_rabbitmq_password: "${RABBITMQ_PASSWORD}"
      SECRETS_postgres_password: "${POSTGRES_PASSWORD}"
      SECRETS_memcached_password: "${MEMCACHED_PASSWORD}"
      SECRETS_redis_password: "${REDIS_PASSWORD}"
      SECRETS_secret_key: "${ZULIP_SECRET_KEY}"

      # Domain configuration
      SETTING_EXTERNAL_HOST: "chat.dollhousemcp.com"
      SETTING_ZULIP_ADMINISTRATOR: "${ZULIP_ADMINISTRATOR}"

      # Email configuration via Resend SMTP
      SETTING_EMAIL_HOST: "smtp.resend.com"
      SETTING_EMAIL_HOST_USER: "resend"
      SECRETS_email_password: "${RESEND_API_KEY}"
      SETTING_EMAIL_PORT: "465"
      SETTING_EMAIL_USE_SSL: "True"
      SETTING_EMAIL_USE_TLS: "False"
      SETTING_NOREPLY_EMAIL_ADDRESS: "noreply@dollhousemcp.com"
      SETTING_ADD_TOKENS_TO_NOREPLY_ADDRESS: "False"

      # Authentication
      ZULIP_AUTH_BACKENDS: "EmailAuthBackend"

      # Enable mobile push notifications (uses Zulip's push service)
      SETTING_ZULIP_SERVICE_PUSH_NOTIFICATIONS: "True"

      # Disable HTTPS requirement since Cloudflare handles SSL
      DISABLE_HTTPS: "True"

      # Trust Cloudflare's reverse proxy (entire Cloudflare IP ranges) + Docker gateway for local access
      LOADBALANCER_IPS: "172.19.0.1,173.245.48.0/20,103.21.244.0/22,103.22.200.0/22,103.31.4.0/22,141.101.64.0/18,108.162.192.0/18,190.93.240.0/20,188.114.96.0/20,197.234.240.0/22,198.41.128.0/17,162.158.0.0/15,104.16.0.0/13,104.24.0.0/14,172.64.0.0/13,131.0.72.0/22"

    volumes:
      - "zulip:/data:rw"
    ulimits:
      nofile:
        soft: 1000000
        hard: 1048576
    depends_on:
      - database
      - memcached
      - rabbitmq
      - redis

  formatter-bot:
    build: ./bots/formatter
    restart: unless-stopped
    environment:
      ZULIP_SITE: "https://chat.dollhousemcp.com"
      ZULIP_EMAIL: "${FORMATTER_BOT_EMAIL}"
      ZULIP_API_KEY: "${FORMATTER_BOT_API_KEY}"
    depends_on:
      - zulip

  email-notifier:
    build: ./bots/email-notifier
    restart: unless-stopped
    environment:
      EMAIL_BOT_API_KEY: "${EMAIL_BOT_API_KEY}"
    volumes:
      # Mount config so changes don't require rebuild
      - ./bots/email-notifier/config.yaml:/app/config.yaml:ro
      # Mount Gmail OAuth credentials (created during setup)
      - ./bots/email-notifier/credentials.json:/app/credentials.json:ro
      - ./bots/email-notifier/token.json:/app/token.json:rw
    depends_on:
      - zulip

  mcp-news-bot:
    build: ./bots/mcp-news-bot
    restart: unless-stopped
    environment:
      FORMATTER_BOT_API_KEY: "${FORMATTER_BOT_API_KEY}"
      # Optional: Higher GitHub rate limits (5000/hour vs 60/hour)
      # GITHUB_TOKEN: "${GITHUB_TOKEN}"
    volumes:
      # Persist seen items between restarts
      - ./bots/mcp-news-bot/seen_items.json:/app/seen_items.json:rw
    depends_on:
      - zulip

  ai-news-bot:
    build: ./bots/ai-news-bot
    restart: unless-stopped
    environment:
      FORMATTER_BOT_API_KEY: "${FORMATTER_BOT_API_KEY}"
    volumes:
      # Persist seen items between restarts
      - ./bots/ai-news-bot/seen_items.json:/app/seen_items.json:rw
    depends_on:
      - zulip

  merview-news-bot:
    build: ./bots/merview-news-bot
    restart: unless-stopped
    environment:
      MERVIEW_NEWS_BOT_API_KEY: "${MERVIEW_NEWS_BOT_API_KEY}"
    volumes:
      # Persist seen items between restarts
      - ./bots/merview-news-bot/seen_items.json:/app/seen_items.json:rw
    # Note: This bot connects to Merview Zulip at chat.merview.com

  merview-github-bot:
    build: ./bots/merview-github-bot
    restart: unless-stopped
    environment:
      MERVIEW_GITHUB_BOT_API_KEY: "${MERVIEW_GITHUB_BOT_API_KEY}"
      # Optional: Higher GitHub rate limits (5000/hour vs 60/hour)
      # GITHUB_TOKEN: "${GITHUB_TOKEN}"
    volumes:
      # Persist seen items between restarts
      - ./bots/merview-github-bot/seen_items.json:/app/seen_items.json:rw
    # Note: This bot connects to a separate Merview Zulip instance
    # Configure the site URL in bots/merview-github-bot/config.yaml

  merview-digest-bot:
    build: ./bots/merview-digest-bot
    restart: unless-stopped
    environment:
      MERVIEW_DIGEST_BOT_API_KEY: "${MERVIEW_DIGEST_BOT_API_KEY}"
      # Optional: Higher GitHub rate limits (5000/hour vs 60/hour)
      GITHUB_TOKEN: "${GITHUB_TOKEN}"
    # Note: This bot connects to a separate Merview Zulip instance
    # Configure the site URL in bots/merview-digest-bot/config.yaml

  claude-skills-bot:
    build: ./bots/claude-skills-bot
    restart: unless-stopped
    environment:
      FORMATTER_BOT_API_KEY: "${FORMATTER_BOT_API_KEY}"
    volumes:
      # Persist seen items between restarts
      - ./bots/claude-skills-bot/seen_items.json:/app/seen_items.json:rw
    depends_on:
      - zulip

  discord-merview-bot:
    build: ./bots/discord-merview-bot
    restart: unless-stopped
    environment:
      DISCORD_BOT_TOKEN: "${DISCORD_MERVIEW_BOT_TOKEN}"
      MERVIEW_URL: "https://merview.com/"
    # Note: This bot runs on both Dollhouse MCP and Merview Discord servers
    # It watches for .md file uploads and replies with "View in Merview" buttons

  arxiv-news-bot:
    build:
      context: ./bots
      dockerfile: arxiv-news-bot/Dockerfile
    restart: unless-stopped
    environment:
      FORMATTER_BOT_API_KEY: "${FORMATTER_BOT_API_KEY}"
    volumes:
      - ./bots/arxiv-news-bot/seen_items.json:/app/arxiv-news-bot/seen_items.json:rw
    depends_on:
      - zulip

  youtube-news-bot:
    build:
      context: ./bots
      dockerfile: youtube-news-bot/Dockerfile
    restart: unless-stopped
    environment:
      FORMATTER_BOT_API_KEY: "${FORMATTER_BOT_API_KEY}"
      YOUTUBE_API_KEY: "${YOUTUBE_API_KEY}"
    volumes:
      - ./bots/youtube-news-bot/seen_items.json:/app/youtube-news-bot/seen_items.json:rw
    depends_on:
      - zulip

  linkedin-news-bot:
    build:
      context: ./bots
      dockerfile: linkedin-news-bot/Dockerfile
    restart: unless-stopped
    environment:
      FORMATTER_BOT_API_KEY: "${FORMATTER_BOT_API_KEY}"
    volumes:
      - ./bots/linkedin-news-bot/seen_items.json:/app/linkedin-news-bot/seen_items.json:rw
    depends_on:
      - zulip

  twitter-news-bot:
    build:
      context: ./bots
      dockerfile: twitter-news-bot/Dockerfile
    restart: unless-stopped
    environment:
      FORMATTER_BOT_API_KEY: "${FORMATTER_BOT_API_KEY}"
    volumes:
      - ./bots/twitter-news-bot/seen_items.json:/app/twitter-news-bot/seen_items.json:rw
    depends_on:
      - zulip

  bluesky-news-bot:
    build:
      context: ./bots
      dockerfile: bluesky-news-bot/Dockerfile
    restart: unless-stopped
    environment:
      FORMATTER_BOT_API_KEY: "${FORMATTER_BOT_API_KEY}"
      BLUESKY_IDENTIFIER: "${BLUESKY_IDENTIFIER}"
      BLUESKY_APP_PASSWORD: "${BLUESKY_APP_PASSWORD}"
    volumes:
      - ./bots/bluesky-news-bot/seen_items.json:/app/bluesky-news-bot/seen_items.json:rw
    depends_on:
      - zulip

  mastodon-news-bot:
    build:
      context: ./bots
      dockerfile: mastodon-news-bot/Dockerfile
    restart: unless-stopped
    environment:
      FORMATTER_BOT_API_KEY: "${FORMATTER_BOT_API_KEY}"
    volumes:
      - ./bots/mastodon-news-bot/seen_items.json:/app/mastodon-news-bot/seen_items.json:rw
    depends_on:
      - zulip

volumes:
  zulip:
  postgresql-14:
  rabbitmq:
  redis:
